name: Run Snowflake Notebook Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run notebook conversion
        run: |
          set -e
          echo "ðŸš€ Running convert_ipynb_to_py.py"
          python convert.py

      - name: Validate converted script exists
        run: |
          test -f scripts/data_harmonization.py

      - name: Upload converted scripts to Snowflake stage
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
          SNOWFLAKE_PRIVATE_KEY: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
        run: |
          python - <<EOF
import os
from snowflake.snowpark import Session
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.backends import default_backend

private_key = serialization.load_pem_private_key(
  os.environ["SNOWFLAKE_PRIVATE_KEY"].encode(),
  password=None,
  backend=default_backend()
)
private_key_der = private_key.private_bytes(
  encoding=serialization.Encoding.DER,
  format=serialization.PrivateFormat.PKCS8,
  encryption_algorithm=serialization.NoEncryption()
)

conn_params = {
  "account": os.environ["SNOWFLAKE_ACCOUNT"],
  "user": os.environ["SNOWFLAKE_USER"],
  "role": os.environ["SNOWFLAKE_ROLE"],
  "warehouse": os.environ["SNOWFLAKE_WAREHOUSE"],
  "database": os.environ["SNOWFLAKE_DATABASE"],
  "schema": os.environ["SNOWFLAKE_SCHEMA"],
  "private_key": private_key_der
}

session = Session.builder.configs(conn_params).create()

# Upload all converted .py scripts in scripts folder to stage
scripts_folder = "scripts"
stage_name = '"ORANGE_ZONE_SBX_TA"."PUBLIC"."CONNECTIONS"'

for file in os.listdir(scripts_folder):
  if file.endswith(".py"):
      local_path = os.path.join(scripts_folder, file)
      session.file.put(f"file://{local_path}", stage_name, auto_compress=False, overwrite=True)

print(" All scripts uploaded to Snowflake stage successfully")
session.close()
EOF

      - name: Run converted Snowflake script
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_PRIVATE_KEY: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
        run: |
          echo "ðŸš€ Running data_harmonization.py"
          python scripts/data_harmonization.py
